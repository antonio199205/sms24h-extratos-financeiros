<% layout('layout', { title: 'Dashboard - Financeiro Invoices', activeMenu: 'dashboard' }) %>
<div class="top-bar">
  <div class="search-form">
    <form method="GET" action="/search" class="d-flex gap-3 w-100">
      <input type="text" class="form-control" name="searchTerm" id="searchTerm" placeholder="Extrato completo por CPF ou TX ID...">
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-search"></i>
      </button>
    </form>
  </div>
  <div class="user-info">
    <div>
      <small class="text-muted">Bem-vindo</small>
      <div class="fw-bold"><%= user.nome %></div>
    </div>
  </div>
</div>
<div class="row mt-3 mb-3">
  <div class="col-md-4">
    <form method="GET" action="/" class="d-flex gap-2">
      <input type="date" class="form-control" name="filterDate" id="filterDate">
      <button type="submit" class="btn btn-outline-primary">
        <i class="fas fa-filter"></i> Filtrar
      </button>
      <a href="/" class="btn btn-outline-secondary">
        <i class="fas fa-times"></i> Limpar
      </a>
    </form>
  </div>
</div>
<% if (typeof messages !== 'undefined') { %>
  <% if (messages.error) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <%= messages.error %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% } %>
  <% if (messages.success) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <%= messages.success %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% } %>
<% } %>
<h2 class="page-title">Últimas Recargas</h2>
<div class="invoice-table table-responsive">
  <table class="table table-hover align-middle">
    <thead>
      <tr>
        <th>ID</th>
        <th>Email</th>
        <th>Gateway</th>
        <th>Valor</th>
        <th>Status</th>
        <th>Data</th>
        <th>Ação</th>
      </tr>
    </thead>
    <tbody>
      <% if (invoices && invoices.data && invoices.data.length > 0) { %>
        <% invoices.data.forEach(invoice => { %>
          <tr>
            <td><strong>#<%= invoice.id %></strong></td>
            <td><%= invoice.email %></td>
            <td><%= invoice.gateway %></td>
            <td>R$ <%= parseFloat(invoice.valor || 0).toFixed(2) %></td>
            <td>
              <span class="badge-status <%= invoice.status %>">
                <%= invoice.status %>
              </span>
            </td>
            <td><%= new Date(invoice.createdAt).toLocaleDateString('pt-BR') %></td>
            <td>
              <a href="/invoice/<%= invoice.id %>" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-eye"></i> Ver
              </a>
            </td>
          </tr>
        <% }); %>
      <% } else { %>
        <tr>
          <td colspan="7" class="text-center text-muted py-4">
            Nenhum invoice encontrado
          </td>
        </tr>
      <% } %>
    </tbody>
  </table>
</div>
<% if (invoices && invoices.pages > 1) { %>
  <nav aria-label="Paginação">
    <ul class="pagination justify-content-center mt-3">
      <% const pageParam = filterDate ? `?filterDate=${filterDate}&page` : '?page'; %>
      <% if (invoices.page > 1) { %>
        <li class="page-item">
          <a class="page-link" href="/<%= pageParam %>=1">Primeira</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="/<%= pageParam %>=<%= invoices.page - 1 %>">Anterior</a>
        </li>
      <% } %>
      <% for (let i = Math.max(1, invoices.page - 2); i <= Math.min(invoices.pages, invoices.page + 2); i++) { %>
        <li class="page-item <%= (i === invoices.page) ? 'active' : '' %>">
          <a class="page-link" href="/<%= pageParam %>=<%= i %>"><%= i %></a>
        </li>
      <% } %>
      <% if (invoices.page < invoices.pages) { %>
        <li class="page-item">
          <a class="page-link" href="/<%= pageParam %>=<%= invoices.page + 1 %>">Próxima</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="/<%= pageParam %>=<%= invoices.pages %>">Última</a>
        </li>
      <% } %>
    </ul>
  </nav>
<% } %>
