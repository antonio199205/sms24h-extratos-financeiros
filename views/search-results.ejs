
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resultados de Busca - Financeiro Invoices</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #667eea;
      --secondary: #764ba2;
    }
    body {
      background-color: #f5f7fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .sidebar {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      min-height: 100vh;
      padding: 20px;
      color: white;
    }
    .sidebar .brand {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 30px;
    }
    .sidebar .nav-link {
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 10px;
      border-radius: 5px;
      transition: all 0.3s;
    }
    .sidebar .nav-link:hover {
      color: white;
      background: rgba(255, 255, 255, 0.1);
    }
    .main-content {
      padding: 30px;
    }
    @media (max-width: 767px) {
      .main-content {
        padding: 10px;
      }
      .invoice-details-row {
        grid-template-columns: 1fr !important;
        gap: 8px;
      }
      .invoice-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        font-size: 15px;
      }
      .btn-group-action {
        width: 100%;
        flex-direction: column;
        gap: 6px;
      }
      .ativacoes-table, .ativacoes-table thead, .ativacoes-table tbody, .ativacoes-table th, .ativacoes-table td, .ativacoes-table tr {
        display: block;
        width: 100%;
      }
      .ativacoes-table thead {
        display: none;
      }
      .ativacoes-table tr {
        margin-bottom: 15px;
        border-radius: 8px;
        background: #f8f9fa;
        box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        border: 1px solid #e9ecef;
        padding: 8px 0;
      }
      .ativacoes-table td {
        border: none;
        padding: 8px 12px;
        position: relative;
        text-align: left;
      }
      .ativacoes-table td:before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--primary);
        display: block;
        font-size: 12px;
        margin-bottom: 2px;
      }
      .invoice-group {
        padding: 10px;
      }
      .search-info {
        font-size: 15px;
        padding: 10px;
      }
      .back-button {
        margin-bottom: 10px;
      }
      .page-title {
        font-size: 20px;
      }
    }
    .top-bar {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .page-title {
      color: #333;
      font-weight: 700;
      margin-bottom: 20px;
    }
    .search-info {
      background: white;
      border-left: 4px solid var(--primary);
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 30px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .invoice-group {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .invoice-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .invoice-header h4 {
      margin: 0;
      font-size: 18px;
    }
    .invoice-details-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    .detail-item {
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
      border-left: 3px solid var(--primary);
    }
    .detail-item strong {
      color: #666;
      display: block;
      font-size: 12px;
      text-transform: uppercase;
      margin-bottom: 5px;
    }
    .detail-item span {
      color: #333;
      font-size: 16px;
      font-weight: 500;
    }
    .ativacoes-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    .ativacoes-table thead {
      background-color: #f0f3f7;
      border-bottom: 2px solid var(--primary);
    }
    .ativacoes-table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: var(--primary);
      font-size: 13px;
      text-transform: uppercase;
    }
    .ativacoes-table td {
      padding: 12px;
      border-bottom: 1px solid #e9ecef;
    }
    .ativacoes-table tbody tr:hover {
      background-color: #f8f9fa;
    }
    .btn-group-action {
      display: flex;
      gap: 10px;
    }
    .back-button {
      margin-bottom: 20px;
    }
    .badge-status {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-pago {
      background-color: #d4edda;
      color: #155724;
    }
    .badge-aguardando {
      background-color: #fff3cd;
      color: #856404;
    }
    .badge-pendente {
      background-color: #f8d7da;
      color: #721c24;
    }
    @media print {
      .sidebar, .top-bar, .back-button, .btn-group-action, .btn-close {
        display: none !important;
      }
      .main-content {
        padding: 0;
      }
      .invoice-group {
        page-break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
      }
    }
  </style>
</head>
<body>
  <div class="row g-0" style="min-height: 100vh;">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 sidebar">
      <div class="brand">
        <i class="fas fa-dollar-sign"></i> Financeiro
      </div>
      <nav class="nav flex-column">
        <a href="/" class="nav-link">
          <i class="fas fa-home"></i> Dashboard
        </a>
        <a href="/logout" class="nav-link mt-auto">
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10 main-content">
      <!-- Botão Voltar -->
      <div class="back-button">
        <a href="/" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left"></i> Voltar
        </a>
      </div>

      <!-- Search Info -->
      <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 0.5rem;">
        <h2 class="page-title" style="margin-bottom: 0;">
          <i class="fas fa-search"></i> Resultados de Busca
        </h2>
        <button class="btn btn-primary btn-sm" onclick="window.print()" style="margin-left: 10px;">
          <i class="fas fa-print"></i> IMPRIMIR TODO HISTÓRICO
        </button>
      </div>
      <div class="search-info">
        <strong>Busca por <%= tipo_busca %>:</strong> <%= searchTerm %> 
        <% if (tipo_busca === 'TX_ID' && usuario && usuario.cpf) { %>
          | <strong>CPF:</strong> <%= usuario.cpf %>
        <% } %>
        <% if(alerta){ %>
          <div class="alert alert-warning mt-2" role="alert">
            <i class="fas fa-exclamation-triangle"></i><strong>Usuário com suspeita de fraude</strong>.
        </div>
        <% } %>
        <% if (invoices && invoices.length) { %>
          | <strong><%= invoices.length %> invoice(s) encontrado(s)</strong>
        <% } %>
          | <strong> Saldo Atual: R$ <%= usuario.credito || '-' %></strong>
      </div>

      <!-- Invoices por Data -->
      <% if (invoices && invoices.length > 0) { %>
        <% invoices.forEach((invoice, idx) => { %>
          <div class="invoice-group" id="invoiceGroup<%= idx %>">
            <!-- Invoice Header -->
            <div class="invoice-header">
              <h4><i class="fas fa-file-invoice"></i> Invoice #<%= invoice.id %> - <%= invoice.metodoNome || invoice.gateway %></h4>
              <div class="btn-group-action">
                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#invoiceModal<%= idx %>">
                  <i class="fas fa-expand"></i> Detalhes
                </button>
                <button class="btn btn-light btn-sm" onclick="printInvoice(<%= idx %>)">
                  <i class="fas fa-print"></i> Imprimir
                </button>
              </div>
            </div>

            <!-- Invoice Details Grid -->
            <div class="invoice-details-row">
              <div class="detail-item">
                <strong>ID</strong>
                <span><%= invoice.id %></span>
              </div>
              <div class="detail-item">
                <strong>Email</strong>
                <span><%= invoice.email %></span>
              </div>
              <div class="detail-item">
                <strong>Gateway</strong>
                <span><%= invoice.metodoNome || invoice.gateway %></span>
              </div>
              <div class="detail-item">
                <strong>Gateway ID/TX ID</strong>
                <span><%= invoice.invoice_gateway_id || '-' %></span>
              </div>
              <div class="detail-item">
                <strong>Valor</strong>
                <span>R$ <%= parseFloat(invoice.valor || 0).toFixed(2) %></span>
              </div>
              <div class="detail-item">
                <strong>Status</strong>
                <span>
                  <span class="badge-status <%= invoice.status === 'PAGO' ? 'badge-pago' : invoice.status === 'AGUARDANDO_PAGAMENTO' ? 'badge-aguardando' : 'badge-pendente' %>"><%= invoice.status %></span>
                </span>
              </div>
              <div class="detail-item">
                <strong>Data de Criação</strong>
                <span><%= formatDate(invoice.createdAt) %></span>
              </div>
              <div class="detail-item">
                <strong>Data de Pagamento</strong>
                <span><%= formatDate(invoice.data_pagamento) %></span>
              </div>
              <% if (invoice.qr_text) { %>
                <div class="detail-item" style="grid-column: 1 / -1;">
                  <strong>QR Text</strong>
                  <span style="font-size: 12px; word-break: break-all;"><%= invoice.qr_text %></span>
                </div>
              <% } %>
            </div>

            <!-- Ativações Table -->
            <% if (invoice.ativacoes && invoice.ativacoes.length > 0) { %>
              <div>
                <h5 style="color: var(--primary); margin-top: 20px; margin-bottom: 10px;">
                  <i class="fas fa-check-circle"></i> Ativações (<%= invoice.ativacoes.length %>)
                </h5>
                <table class="ativacoes-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Serviço</th>
                      <th>Chip</th>
                      <th>Preço</th>
                      <th>Status</th>
                      <th>Data Inicial</th>
                      <th>SMS Code</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% invoice.ativacoes.forEach(ativacao => { %>
                      <tr>
                        <td data-label="ID"><strong>#<%= ativacao.id %></strong></td>
                        <td data-label="Serviço"><%= ativacao.service_name || ativacao.alias_service || '-' %></td>
                        <td data-label="Chip"><%= ativacao.chip_number || '-' %></td>
                        <td data-label="Preço"><%= typeof ativacao.service_price !== 'undefined' ? 'R$ ' + parseFloat(ativacao.service_price).toFixed(2) : '-' %></td>
                        <td data-label="Status">
                          <% let badgeClass = 'badge-pendente'; let statusText = 'Pendente';
                             if (ativacao.status === 6 || ativacao.status === 2|| ativacao.status === 3) { badgeClass = 'badge-pago'; statusText = 'Confirmado'; }
                             else if (ativacao.status === 8) { badgeClass = 'badge-pendente'; statusText = 'Cancelado'; }
                             else if (ativacao.status === 1 || ativacao.status === -1) { badgeClass = 'badge-aguardando'; statusText = 'Pendente'; }
                          %>
                          <span class="badge-status <%= badgeClass %>"><%= statusText %></span>
                        </td>
                        <td data-label="Data Inicial"><%= formatDate(ativacao.initial_time) %></td>
                        <td data-label="SMS Code">
                          <% if (ativacao.status === 6 || ativacao.status === 2|| ativacao.status === 3) { %>
                            <%= ativacao.last_code || '(Somente codigo dos ultimos 30 dias sao exibidos)' %>
                          <% } else { %>
                            -
                          <% } %>
                        </td>
                      </tr>
                    <% }); %>
                  </tbody>
                </table>
              </div>
            <% } else { %>
              <div style="text-align: center; padding: 20px; color: #999;">
                <i class="fas fa-info-circle"></i> Nenhuma ativação registrada para este invoice
              </div>
            <% } %>
          </div>
          
          <!-- Modal Detalhes -->
          <div class="modal fade" id="invoiceModal<%= idx %>" tabindex="-1">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%)); color: white;">
                  <h5 class="modal-title"><i class="fas fa-file-invoice"></i> Invoice #<%= invoice.id %></h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                      <strong style="color: #666; font-size: 12px;">ID:</strong>
                      <p><%= invoice.id %></p>
                    </div>
                    <div>
                      <strong style="color: #666; font-size: 12px;">Email:</strong>
                      <p><%= invoice.email %></p>
                    </div>
                    <div>
                      <strong style="color: #666; font-size: 12px;">Gateway:</strong>
                      <p><%= invoice.metodoNome || invoice.gateway %></p>
                    </div>
                    <div>
                      <strong style="color: #666; font-size: 12px;">Gateway ID/TX ID:</strong>
                      <p><%= invoice.invoice_gateway_id || '-' %></p>
                    </div>
                    <div>
                      <strong style="color: #666; font-size: 12px;">Valor:</strong>
                      <p>R$ <%= parseFloat(invoice.valor || 0).toFixed(2) %></p>
                    </div>
                    <div>
                      <strong style="color: #666; font-size: 12px;">Status:</strong>
                      <p>
                        <span class="badge-status <%= invoice.status === 'PAGO' ? 'badge-pago' : invoice.status === 'AGUARDANDO_PAGAMENTO' ? 'badge-aguardando' : 'badge-pendente' %>">
                          <%= invoice.status %>
                        </span>
                      </p>
                    </div>
                    <div>
                      <strong style="color: #666; font-size: 12px;">Data de Criação:</strong>
                      <p><%= invoice.createdAt %></p>
                    </div>
                    <div>
                      <strong style="color: #666; font-size: 12px;">Data de Pagamento:</strong>
                      <p><%= invoice.data_pagamento || '-' %></p>
                    </div>
                    <% if (invoice.qr_text) { %>
                      <div style="grid-column: 1 / -1;">
                        <strong style="color: #666; font-size: 12px;">QR Text:</strong>
                        <p style="font-size: 12px; word-break: break-all;"><%= invoice.qr_text %></p>
                      </div>
                    <% } %>
                  </div>

                  <!-- QR Code -->
                  <% if (invoice.qrcode) { %>
                    <div style="text-align: center; padding: 20px; border-top: 1px solid #e9ecef;">
                      <strong style="color: #666;">QR Code:</strong>
                      <div style="margin-top: 10px;">
                        <img src="<%= invoice.qrcode %>" alt="QR Code" style="max-width: 250px; height: auto;">
                      </div>
                    </div>
                  <% } %>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                  <button type="button" class="btn btn-primary" onclick="printInvoice(<%= idx %>)">
                    <i class="fas fa-print"></i> Imprimir
                  </button>
                </div>
              </div>
            </div>
          </div>
        <% }); %>
      <% } else { %>
        <div class="alert alert-info" role="alert">
          <i class="fas fa-info-circle"></i> Nenhum invoice encontrado para este usuário.
        </div>
      <% } %>
      <% if (typeof ativacoesSemInvoice !== 'undefined' && ativacoesSemInvoice.length > 0) { %>
        <div class="invoice-group">
          <div class="invoice-header">
            <h4><i class="fas fa-exclamation-circle"></i> Ativações sem Invoice</h4>
          </div>
          <table class="ativacoes-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Serviço</th>
                <th>Chip</th>
                <th>Preço</th>
                <th>Status</th>
                <th>Data Inicial</th>
                <th>SMS Code</th>
              </tr>
            </thead>
            <tbody>
              <% ativacoesSemInvoice.forEach(ativacao => { %>
                <tr>
                  <td data-label="ID"><strong>#<%= ativacao.id %></strong></td>
                  <td data-label="Serviço"><%= ativacao.service_name || ativacao.alias_service || '-' %></td>
                  <td data-label="Chip"><%= ativacao.chip_number || '-' %></td>
                  <td data-label="Preço"><%= typeof ativacao.service_price !== 'undefined' ? 'R$ ' + parseFloat(ativacao.service_price).toFixed(2) : '-' %></td>
                  <td data-label="Status">
                    <% let badgeClass = 'badge-pendente'; let statusText = 'Pendente';
                       if (ativacao.status === 6) { badgeClass = 'badge-pago'; statusText = 'Confirmado'; }
                       else if (ativacao.status === 8) { badgeClass = 'badge-pendente'; statusText = 'Cancelado'; }
                       else if (ativacao.status === 1 || ativacao.status === -1) { badgeClass = 'badge-aguardando'; statusText = 'Pendente'; }
                    %>
                    <span class="badge-status <%= badgeClass %>"><%= statusText %></span>
                  </td>
                  <td data-label="Data Inicial"><%= formatDate(ativacao.initial_time) %></td>
                  <td data-label="SMS Code">
                    <% if (ativacao.status === 6) { %>
                      <%= ativacao.last_code || '(Somente codigo dos ultimos 30 dias sao exibidos)' %>
                    <% } else { %>
                      -
                    <% } %>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function printInvoice(idx) {
      const printContent = document.getElementById(`invoiceGroup${idx}`).outerHTML;
      // Tenta extrair o número do invoice do conteúdo
      let invoiceId = '';
      const match = printContent.match(/Invoice #(\d+)/);
      if (match) invoiceId = match[1];
      const printWindow = window.open('', '', 'height=600,width=800');
      // Copia o head do documento atual para manter estilos
      const headContent = document.head.innerHTML;
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Invoice #${invoiceId}</title>
          ${headContent}
        </head>
        <body style="background:white;">
          ${printContent}
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }
  </script>
</body>
</html>
