
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resultados de Busca - Financeiro Invoices</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <%- include('partials/styles') %>
</head>
<body>
  <div class="row g-0" style="min-height: 100vh;">
    <%- include('partials/sidebar', { activeMenu: 'dashboard', user: user }) %>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10 col-12 main-content">
      <!-- Mobile Menu Button -->
      <div class="d-md-none mb-3">
        <button class="btn btn-outline-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
          <i class="fas fa-bars"></i> Menu
        </button>
      </div>

      <!-- Botão Voltar -->
      <div class="back-button">
        <a href="/" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left"></i> Voltar
        </a>
      </div>

      <!-- Search Info -->
      <div class="print-keep">
        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 0.5rem;">
          <h2 class="page-title" style="margin-bottom: 0;">
            <i class="fas fa-search"></i> Resultados de Busca
          </h2>
          <button class="btn btn-primary btn-sm" onclick="window.print()" style="margin-left: 10px;">
            <i class="fas fa-print"></i> IMPRIMIR TODO HISTÓRICO
          </button>
        </div>
        <div class="search-info">
          <strong>Busca por <%= tipo_busca %>:</strong> <%= searchTerm %> 
          <% if (tipo_busca === 'TX_ID' && usuario && usuario.cpf) { %>
            | <strong>CPF:</strong> <%= usuario.cpf %>
          <% } %>
          <% if(alerta){ %>
            <div class="alert alert-warning mt-2" role="alert">
              <i class="fas fa-exclamation-triangle"></i><strong>Usuário com suspeita de fraude</strong>.
            </div>
          <% } %>
          <% if (invoices && invoices.length) { %>
            | <strong><%= invoices.length %> invoice(s) encontrado(s)</strong>
          <% } %>
            | <strong> Saldo Atual: R$ <%= usuario.credito || '-' %></strong>
        </div>
      </div>
      <!-- Invoices por Data -->
      <% if (invoices && invoices.length > 0) { %>
        <% invoices.forEach((invoice, idx) => { %>
          <div class="invoice-group" id="invoiceGroup<%= idx %>">
            <!-- Invoice Header -->
            <div class="invoice-header">
              <h4><i class="fas fa-file-invoice"></i> Invoice #<%= invoice.id %> - <%= invoice.metodoNome || invoice.gateway %></h4>
              <div class="btn-group-action">
                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#invoiceModal<%= idx %>">
                  <i class="fas fa-expand"></i> Detalhes
                </button>
                <button class="btn btn-light btn-sm" onclick="printInvoice(<%= idx %>)">
                  <i class="fas fa-print"></i> Imprimir
                </button>
              </div>
            </div>

            <!-- Invoice Details Grid -->
            <div class="invoice-details-row">
              <div class="detail-item">
                <strong>ID</strong>
                <span><%= invoice.id %></span>
              </div>
              <div class="detail-item">
                <strong>Email</strong>
                <span><%= invoice.email %></span>
              </div>
              <div class="detail-item">
                <strong>Gateway</strong>
                <span><%= invoice.metodoNome || invoice.gateway %></span>
              </div>
              <div class="detail-item">
                <strong>Gateway ID/TX ID</strong>
                <span><%= invoice.invoice_gateway_id || '-' %></span>
              </div>
              <div class="detail-item">
                <strong>Valor</strong>
                <span>R$ <%= parseFloat(invoice.valor || 0).toFixed(2) %></span>
              </div>
              <div class="detail-item">
                <strong>Status</strong>
                <span>
                  <span class="badge-status <%= invoice.status === 'PAGO' ? 'badge-pago' : invoice.status === 'AGUARDANDO_PAGAMENTO' ? 'badge-aguardando' : 'badge-pendente' %>"><%= invoice.status %></span>
                </span>
              </div>
              <div class="detail-item">
                <strong>Data de Criação</strong>
                <span><%= formatDate(invoice.createdAt) %></span>
              </div>
              <div class="detail-item">
                <strong>Data de Pagamento</strong>
                <span><%= formatDate(invoice.data_pagamento) %></span>
              </div>
              <% if (invoice.qr_text) { %>
                <div class="detail-item" style="grid-column: 1 / -1;">
                  <strong>QR Text</strong>
                  <span style="font-size: 12px; word-break: break-all;"><%= invoice.qr_text %></span>
                </div>
              <% } %>
            </div>

            <!-- Ativações Table -->
            <% if (invoice.ativacoes && invoice.ativacoes.length > 0) { %>
              <div>
                <h5 style="color: var(--primary); margin-top: 20px; margin-bottom: 10px;">
                  <i class="fas fa-check-circle"></i> Ativações (<%= invoice.ativacoes.length %>)
                </h5>
                <table class="ativacoes-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Serviço</th>
                      <th>Chip</th>
                      <th>Preço</th>
                      <th>Status</th>
                      <th>Data Inicial</th>
                      <th>SMS Code</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% invoice.ativacoes.forEach(ativacao => { %>
                      <tr>
                        <td data-label="ID"><strong>#<%= ativacao.id %></strong></td>
                        <td data-label="Serviço"><%= ativacao.service_name || ativacao.alias_service || '-' %></td>
                        <td data-label="Chip"><%= ativacao.chip_number || '-' %></td>
                        <td data-label="Preço"><%= typeof ativacao.service_price !== 'undefined' ? 'R$ ' + parseFloat(ativacao.service_price).toFixed(2) : '-' %></td>
                        <td data-label="Status">
                          <% let badgeClass = 'badge-pendente'; let statusText = 'Pendente';
                             if (ativacao.status === 6 || ativacao.status === 2|| ativacao.status === 3) { badgeClass = 'badge-pago'; statusText = 'Confirmado'; }
                             else if (ativacao.status === 8) { badgeClass = 'badge-pendente'; statusText = 'Cancelado'; }
                             else if (ativacao.status === 1 || ativacao.status === -1) { badgeClass = 'badge-aguardando'; statusText = 'Pendente'; }
                          %>
                          <span class="badge-status <%= badgeClass %>"><%= statusText %></span>
                        </td>
                        <td data-label="Data Inicial"><%= formatDate(ativacao.initial_time) %></td>
                        <td data-label="SMS Code">
                          <% if (ativacao.status === 6 || ativacao.status === 2|| ativacao.status === 3) { %>
                            <%= ativacao.last_code || '(Somente codigo dos ultimos 30 dias sao exibidos)' %>
                          <% } else { %>
                            -
                          <% } %>
                        </td>
                      </tr>
                    <% }); %>
                  </tbody>
                </table>
              </div>
            <% } else { %>
              <div style="text-align: center; padding: 20px; color: #999;">
                <i class="fas fa-info-circle"></i> Nenhuma ativação registrada para este invoice
              </div>
            <% } %>
          </div>
          
          <!-- Modal Detalhes -->
          <div class="modal fade" id="invoiceModal<%= idx %>" tabindex="-1">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%)); color: white;">
                  <h5 class="modal-title"><i class="fas fa-file-invoice"></i> Invoice #<%= invoice.id %></h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                      <strong style="color: #666; font-size: 12px;">ID:</strong>
                      <p><%= invoice.id %></p>
                    </div>
                    <div>
                      <strong style="color: #666; font-size: 12px;">Email:</strong>
                      <p><%= invoice.email %></p>
                    </div>
                    <div>
                      <strong style="color: #666; font-size: 12px;">Gateway:</strong>
                      <p><%= invoice.metodoNome || invoice.gateway %></p>
                    </div>
                    <div>
                      <strong style="color: #666; font-size: 12px;">Gateway ID/TX ID:</strong>
                      <p><%= invoice.invoice_gateway_id || '-' %></p>
                    </div>
                    <div>
                      <strong style="color: #666; font-size: 12px;">Valor:</strong>
                      <p>R$ <%= parseFloat(invoice.valor || 0).toFixed(2) %></p>
                    </div>
                    <div>
                      <strong style="color: #666; font-size: 12px;">Status:</strong>
                      <p>
                        <span class="badge-status <%= invoice.status === 'PAGO' ? 'badge-pago' : invoice.status === 'AGUARDANDO_PAGAMENTO' ? 'badge-aguardando' : 'badge-pendente' %>">
                          <%= invoice.status %>
                        </span>
                      </p>
                    </div>
                    <div>
                      <strong style="color: #666; font-size: 12px;">Data de Criação:</strong>
                      <p><%= invoice.createdAt %></p>
                    </div>
                    <div>
                      <strong style="color: #666; font-size: 12px;">Data de Pagamento:</strong>
                      <p><%= invoice.data_pagamento || '-' %></p>
                    </div>
                    <% if (invoice.qr_text) { %>
                      <div style="grid-column: 1 / -1;">
                        <strong style="color: #666; font-size: 12px;">QR Text:</strong>
                        <p style="font-size: 12px; word-break: break-all;"><%= invoice.qr_text %></p>
                      </div>
                    <% } %>
                  </div>

                  <!-- QR Code -->
                  <% if (invoice.qrcode) { %>
                    <div style="text-align: center; padding: 20px; border-top: 1px solid #e9ecef;">
                      <strong style="color: #666;">QR Code:</strong>
                      <div style="margin-top: 10px;">
                        <img src="<%= invoice.qrcode %>" alt="QR Code" style="max-width: 250px; height: auto;">
                      </div>
                    </div>
                  <% } %>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                  <button type="button" class="btn btn-primary" onclick="printInvoice(<%= idx %>)">
                    <i class="fas fa-print"></i> Imprimir
                  </button>
                </div>
              </div>
            </div>
          </div>
        <% }); %>
      <% } else { %>
        <div class="alert alert-info" role="alert">
          <i class="fas fa-info-circle"></i> Nenhum invoice encontrado para este usuário.
        </div>
      <% } %>
      <% if (typeof ativacoesSemInvoice !== 'undefined' && ativacoesSemInvoice.length > 0) { %>
        <div class="invoice-group">
          <div class="invoice-header">
            <h4><i class="fas fa-exclamation-circle"></i> Ativações sem Invoice</h4>
          </div>
          <table class="ativacoes-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Serviço</th>
                <th>Chip</th>
                <th>Preço</th>
                <th>Status</th>
                <th>Data Inicial</th>
                <th>SMS Code</th>
              </tr>
            </thead>
            <tbody>
              <% ativacoesSemInvoice.forEach(ativacao => { %>
                <tr>
                  <td data-label="ID"><strong>#<%= ativacao.id %></strong></td>
                  <td data-label="Serviço"><%= ativacao.service_name || ativacao.alias_service || '-' %></td>
                  <td data-label="Chip"><%= ativacao.chip_number || '-' %></td>
                  <td data-label="Preço"><%= typeof ativacao.service_price !== 'undefined' ? 'R$ ' + parseFloat(ativacao.service_price).toFixed(2) : '-' %></td>
                  <td data-label="Status">
                    <% let badgeClass = 'badge-pendente'; let statusText = 'Pendente';
                       if (ativacao.status === 6) { badgeClass = 'badge-pago'; statusText = 'Confirmado'; }
                       else if (ativacao.status === 8) { badgeClass = 'badge-pendente'; statusText = 'Cancelado'; }
                       else if (ativacao.status === 1 || ativacao.status === -1) { badgeClass = 'badge-aguardando'; statusText = 'Pendente'; }
                    %>
                    <span class="badge-status <%= badgeClass %>"><%= statusText %></span>
                  </td>
                  <td data-label="Data Inicial"><%= formatDate(ativacao.initial_time) %></td>
                  <td data-label="SMS Code">
                    <% if (ativacao.status === 6) { %>
                      <%= ativacao.last_code || '(Somente codigo dos ultimos 30 dias sao exibidos)' %>
                    <% } else { %>
                      -
                    <% } %>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function printInvoice(idx) {
      const printContent = document.getElementById(`invoiceGroup${idx}`).outerHTML;
      // Tenta extrair o número do invoice do conteúdo
      let invoiceId = '';
      const match = printContent.match(/Invoice #(\d+)/);
      if (match) invoiceId = match[1];
      const printWindow = window.open('', '', 'height=600,width=800');
      // Copia o head do documento atual para manter estilos
      const headContent = document.head.innerHTML;
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Invoice #${invoiceId}</title>
          ${headContent}
        </head>
        <body style="background:white;">
          ${printContent}
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }
  </script>
</body>
</html>
