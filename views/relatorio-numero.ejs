<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relatório por Número - Financeiro Invoices</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <%- include('partials/styles') %>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <%- include('partials/sidebar', { activeMenu: activeMenu, user: user }) %>

      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
        <!-- Mobile Menu Button -->
        <div class="d-md-none mb-3 mt-3">
          <button class="btn btn-outline-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
            <i class="fas fa-bars"></i> Menu
          </button>
        </div>

        <h2 class="page-title">
          <i class="fas fa-phone"></i> Relatório por Número
        </h2>

      <!-- Formulário de Busca -->
      <div class="bg-white rounded-3 p-3 p-md-4 mb-4 shadow-sm">
        <form method="GET" action="/relatorio-numero" class="row g-3">
          <div class="col-md-8">
            <label for="numero" class="form-label">Número de Telefone:</label>
            <input 
              type="text" 
              class="form-control" 
              id="numero" 
              name="numero" 
              value="<%= numero %>"
              placeholder="Digite o número de telefone..."
              required
            >
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">
              <i class="fas fa-search"></i> Buscar
            </button>
          </div>
        </form>
      </div>

      <!-- Resultados -->
      <% if (numero && numero.trim() !== '') { %>
        <% if (activations && activations.length > 0) { %>
          <div class="bg-white rounded-3 p-3 shadow-sm">
            <h5 class="mb-3">
              <i class="fas fa-list"></i> Encontradas <%= activations.length %> ativação(ões) para o número <%= numero %>
            </h5>
            
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Número</th>
                    <th>App/Serviço</th>
                    <th>Data Inicial</th>
                    <th>Status</th>
                    <th>Último Código</th>
                    <th>Nome do Usuário</th>
                    <th>CPF</th>
                    <th>Crédito</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <% activations.forEach(activation => { %>
                    <tr>
                      <td><strong><%= activation.chip_number || '-' %></strong></td>
                      <td><%= activation.service_name || activation.alias_service || '-' %></td>
                      <td><%= formatDate(activation.initial_time) %></td>
                      <td>
                        <% 
                          let badgeClass = 'badge-pendente'; 
                          let statusText = 'Pendente';
                          if (activation.status === 6 || activation.status === 2 || activation.status === 3) { 
                            badgeClass = 'badge-pago'; 
                            statusText = 'Confirmado'; 
                          } else if (activation.status === 8) { 
                            badgeClass = 'badge-pendente'; 
                            statusText = 'Cancelado'; 
                          } else if (activation.status === 1 || activation.status === -1) { 
                            badgeClass = 'badge-aguardando'; 
                            statusText = 'Pendente'; 
                          }
                        %>
                        <span class="badge-status <%= badgeClass %>"><%= statusText %></span>
                      </td>
                      <td>
                        <% if (activation.status === 6 || activation.status === 2 || activation.status === 3) { %>
                          <code><%= activation.last_code || '-' %></code>
                        <% } else { %>
                          -
                        <% } %>
                      </td>
                      <td><%= activation.usuario.nome || '-' %></td>
                      <td><%= activation.usuario.cpf || '-' %></td>
                      <td>R$ <%= activation.usuario.credito ? parseFloat(activation.usuario.credito).toFixed(2) : '0.00' %></td>
                      <td>
                        <% if (activation.usuario.id) { %>
                          <a href="/usuario?id=<%= activation.usuario.id %>" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-user"></i> Ver Usuário
                          </a>
                        <% } else { %>
                          <span class="text-muted">-</span>
                        <% } %>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          </div>
        <% } else { %>
          <div class="alert alert-info" role="alert">
            <i class="fas fa-info-circle"></i> Nenhuma ativação encontrada para o número <strong><%= numero %></strong>.
          </div>
        <% } %>
      <% } %>
      </main>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
